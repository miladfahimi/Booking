# Base image with Maven and Amazon Corretto JDK 17
FROM maven:3.9.8-amazoncorretto-17-al2023

# Install necessary tools for creating users
RUN yum -y update && \
    yum -y install shadow-utils && \
    yum clean all

# Set the working directory
WORKDIR /app

# Create a non-root user for security
RUN useradd -ms /bin/bash appuser

# Ensure Maven cache directory is accessible
RUN mkdir -p /root/.m2 && chown -R appuser:appuser /root/.m2

# Copy the entire project to the container (including the parent POM and backend module)
COPY . /app

# Set the working directory to the backend module
WORKDIR /app/backend

# Run Maven dependency resolution for the backend module
USER appuser
RUN mvn dependency:go-offline -f ../pom.xml

# Expose the application port
EXPOSE 8080

# Volume for Maven caching (optional but useful for development)
VOLUME /root/.m2

# Command to run the application with the backend module
CMD ["mvn", "spring-boot:run", "-f", "../pom.xml", "-pl", "backend"]
