stages:
  - build
  - test
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  CI_REGISTRY: registry.gitlab.com
  CI_PROJECT_NAMESPACE: miladfahimi2012/tennistime
  CI_REGISTRY_USER: "$CI_REGISTRY_USER"
  CI_REGISTRY_PASSWORD: "$CI_REGISTRY_PASSWORD"

services:
  - name: docker:dind
    command: ["--host=tcp://0.0.0.0:2375", "--host=unix:///var/run/docker.sock"]

before_script:
  - apt-get update && apt-get install -y curl bash
  - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY

build:
  stage: build
  tags:
    - booking_app
  image: docker:20.10.16
  script:
    - docker build --platform linux/arm64 -t $CI_REGISTRY/$CI_PROJECT_NAMESPACE/frontend:latest -f frontend/Dockerfile.test ./frontend
    - docker push $CI_REGISTRY/$CI_PROJECT_NAMESPACE/frontend:latest
    - docker build --platform linux/arm64 -t $CI_REGISTRY/$CI_PROJECT_NAMESPACE/authentication:latest -f authentication/Dockerfile.test ./authentication
    - docker push $CI_REGISTRY/$CI_PROJECT_NAMESPACE/authentication:latest
    - docker build --platform linux/arm64 -t $CI_REGISTRY/$CI_PROJECT_NAMESPACE/provider:latest -f provider/Dockerfile.test ./provider
    - docker push $CI_REGISTRY/$CI_PROJECT_NAMESPACE/provider:latest
    - docker build --platform linux/arm64 -t $CI_REGISTRY/$CI_PROJECT_NAMESPACE/bff:latest -f bff/Dockerfile.test ./bff
    - docker push $CI_REGISTRY/$CI_PROJECT_NAMESPACE/bff:latest
    - docker build --platform linux/arm64 -t $CI_REGISTRY/$CI_PROJECT_NAMESPACE/profile:latest -f profile/Dockerfile.test ./profile
    - docker push $CI_REGISTRY/$CI_PROJECT_NAMESPACE/profile:latest
    - docker build --platform linux/arm64 -t $CI_REGISTRY/$CI_PROJECT_NAMESPACE/reservation:latest -f reservation/Dockerfile.test ./reservation
    - docker push $CI_REGISTRY/$CI_PROJECT_NAMESPACE/reservation:latest

test:
  stage: test
  tags:
    - booking_app
  image: maven:3.9.8-amazoncorretto-17-al2023
  cache:
    paths:
      - ~/.m2/repository
  before_script:
    - apt-get update && apt-get install -y curl bash
  script:
    - mvn clean test -f authentication/pom.xml
    - mvn clean test -f provider/pom.xml
    - mvn clean test -f bff/pom.xml
    - mvn clean test -f profile/pom.xml
    - mvn clean test -f reservation/pom.xml

deploy:
  stage: deploy
  tags:
    - booking_app
  image: ubuntu:latest
  services:
    - docker:dind
  before_script:
    - apt-get update && apt-get install -y openssh-client git docker-compose
    - eval $(ssh-agent -s)
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/gitlab_ci_deploy_key
    - chmod 600 ~/.ssh/gitlab_ci_deploy_key
    - ssh-add ~/.ssh/gitlab_ci_deploy_key
    - ssh-keyscan gitlab.com >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - ssh -i ~/.ssh/gitlab_ci_deploy_key -o StrictHostKeyChecking=no root@49.12.109.90 "
      if [ -d /home/TennisTime ]; then
      cd /home/TennisTime && git pull origin main;
      else
      git clone git@gitlab.com:miladfahimi2012/tennistime.git /home/TennisTime;
      fi &&
      cd /home/TennisTime/devops &&
      docker-compose down &&
      docker-compose pull &&
      docker-compose up -d --remove-orphans
      "
  only:
    - main
